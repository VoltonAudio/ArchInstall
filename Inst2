#! /bin/bash

set -uo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR

#check for install errors
systemctl --failed

#ask user if checks completed
echo -n "Were Checks Completed: "
read randovar

#enter username
echo -n "Enter Username: "
read username

#enter kernel
echo -n "Enter Kernel: "
read kernel

#enter additional packages
echo "Type Additional Packages Seperated By A Space"
read addpackages

#set hosts
echo "127.0.0.1   localhost
::1         localhost
127.0.1.1   $HOSTNAME" >> /etc/hosts

#set timezone
ln -sf /usr/share/zoneinfo/Europe/Dublin /etc/localtime

#set hwclock
hwclock --systohc

#edit locale.gen
sed --in-place=.bak 's/^#en_IE\.UTF-8/en_IE\.UTF-8/' /etc/locale.gen

#generate locale.conf
locale-gen

#edit locale.conf
localectl set-locale LANG=en_IE.UTF-8

#install amd gpu drivers
pacman -S --noconfirm mesa mesa-utils lib32-mesa xf86-video-amdgpu vulkan-radeon lib32-vulkan-radeon libva-mesa-driver lib32-libva-mesa-driver mesa-vdpau lib32-mesa-vdpau

#install Xorg
pacman -S --noconfirm xorg-server xorg-xinit

#install sddm
pacman -S --noconfirm sddm sddm-kcm
systemctl enable sddm.service

#install Plasma
pacman -S --noconfirm plasma-desktop
pacman -S --noconfirm kscreen plasma-disks plasma-firewall plasma-systemmonitor discover kinfocenter ksystemlog dolphin konsole powerdevil bluedevil kde-gtk-config breeze-gtk plasma-workspace-wallpapers

#install audio system
pacman -S --noconfirm pulseaudio plasma-pa
#jack2 lib32-jack2 jack_mixer cadence

#install commonly used packages
pacman -S --noconfirm kcalc partitionmanager gwenview spectacle gnupg git testdisk vim kate khotkeys blender neofetch man-db qbittorrent vlc bash-completion beets steam nicotine+

#install firewall
pacman -S --noconfirm nftables
systemctl enable nftables.service
systemctl start nftables.service
pacman -S --noconfirm firewalld
systemctl enable firewalld.service
systemctl start firewalld.service

#install openssh
pacman -S --noconfirm openssh
systemctl enable sshd

#enable SSD trim support
systemctl enable fstrim.timer

#install additional packages
if [ -z "$addpackages" ]
then
      echo "No Additional Packages"
else
      pacman -S --noconfirm $packages
fi

#install packages needed for keyboard layout
pacman -S --noconfirm libxkbcommon libxkbcommon-x11

#set keyboard layout
echo "KEYMAP=uk" >> /etc/vconsole.conf
localectl set-x11-keymap gb

#Mount internal HDD's and SSD's
mkdir /home/$username/Drives
mkdir /home/$username/Drives/1TB
mkdir /home/$username/Drives/2TB
mkdir /home/$username/Drives/3TB
mkdir /home/$username/Drives/256GB
echo "
UUID=EE36076636072F61                       /home/volton/Drives/256GB   ntfs   defaults                                                                                                0 0
UUID=06AAF222AAF20DC5                       /home/volton/Drives/1TB     ntfs   defaults                                                                                                0 0
UUID=4670361717E3B507                       /home/volton/Drives/2TB     ntfs   defaults                                                                                                0 0
UUID=4EFE5B6BFE5B4A7B                       /home/volton/Drives/4TB     ntfs   defaults                                                                                                0 0
" >> /etc/fstab

#copy post.sh
#cp /home/volton/Drives/1TB/ArchSetup/post.sh /home/volton/

#install plymouth
#git clone https://aur.archlinux.org/plymouth.git /home/$username/plymouth
#chown $username:users /home/$username/plymouth
#cd /home/$username/plymouth && sudo -u $username makepkg -sicr --noconfirm

#add plymouth hook
#sed -i "s/HOOKS=(base udev autodetect modconf block filesystems keyboard fsck)/HOOKS=(base udev plymouth autodetect modconf block filesystems keyboard fsck)/g" /etc/mkinitcpio.conf
#mkinitcpio -p $kernel

#sync all cache data to hdd
sync

#reboot
reboot
